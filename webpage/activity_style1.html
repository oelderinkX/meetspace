<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="/javascript/common.js"></script>
    <link rel="stylesheet" href="/webpage/activity_css.css">
	<title>!%TITLE%!</title>
</head>
<html>
<script>
    // CONSTANTS
    var ACTIVITY_ID = '!%ACTIVITYID%!';
    var COUNTRY = '!%COUNTRY%!';
	var REGION = '!%REGION%!';
	var CITY = '!%CITY%!';
	var GAME = '!%GAME%!';

    var timeoutTime = 60000 * 5;

    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        timeoutTime = 60000 * 5;
    }

    function reloadPage() {
        loadPosts();
        loadWhosGoing();

        setTimeout("reloadPage()", timeoutTime);
    }
    setTimeout("reloadPage()", timeoutTime);

    function getAgo(datetime) {
        var now = new Date();

        var minutes = 0;
        var hours = 0;
        var days = 0;
        
        minutes = ( now.getTime() - datetime.getTime());
        minutes /= 1000;
        minutes /= 60;
        minutes = Math.abs(Math.floor(minutes));
        
        if (minutes > 59) {
            hours = minutes / 60;
            hours = Math.abs(Math.floor(hours));
        }
        
        if (hours > 23) {
            days = hours / 24;
            days = Math.abs(Math.floor(days));
        }
        
        var ago = '';
        var timetxt = '';
        
        if (days == 1) {
            ago = '1 day ago';
        } else if (days > 1) {
            ago = days + ' days ago';
        } else if (hours == 1) {
            ago = '1 hour ago';
        } else if (hours > 1) {
            ago = hours + ' hours ago';
        } else if (minutes == 1) {
            ago = '1 minute ago';
        } else {
            ago = minutes + ' minutes ago';
        }
        
        return ago;
    }

    ///
    /// Need to add daylight savings
    ///
    function getGmtAdjustedDateTime(datetime, country, region) {
        var daylightsavings = 0;

        if (country == 'nz') {
            if (datetime.getMonth() > 4 && datetime.getMonth() < 9 ) {
                daylightsavings	= 1;
            }

            datetime.setHours(datetime.getHours() - daylightsavings);
        }

        return datetime;
    }

    function loadPosts() {
        var json = { activityId: ACTIVITY_ID };

        sendPost("/getposts", JSON.stringify(json), function(response) {
            var posts = JSON.parse(response);

            var postElement = '';
            for(var i = 0; i < posts.length; i++) {
                var username = posts[i].username;
				var message = posts[i].message;
				var submissionDate = new Date(posts[i].submissionDate);

                var adjustedDateTime = getGmtAdjustedDateTime(submissionDate, 'nz', 'region!');
		        var agoTxt = getAgo(adjustedDateTime);
		
		        postElement += ' <div class="alert-message alert-message-default"><strong>' + username + '</strong> ' + agoTxt + '<p class="text-break">' + message + '</p></div>';
            }

            document.getElementById("posts").innerHTML = postElement;
        });
    }

    function loadWhosGoing() {
        var json = { activityId: ACTIVITY_ID };

        sendPost("/whosgoing", JSON.stringify(json), function(response) {
            var whosgoing = JSON.parse(response);

            var whosgoingElement = '<ol>';
            var whosnotElement = '<a data-toggle="collapse" href="#notgoingcollapse">Show more...</a><div id="notgoingcollapse" class="panel-collapse collapse"><ul>';
            var modalsElement = '';

            for(var i = 0; i < whosgoing.length; i++) {
                if (whosgoing[i].status == 1) {
                    whosgoingElement += '<li>' + whosgoing[i].username + '</li>';
                }
            }
            whosgoingElement += '</ol>';

            for(var i = 0; i < whosgoing.length; i++) {
                if (whosgoing[i].status == 0) {
                    whosnotElement += '<li style="color:#CCCCCC">';
                    whosnotElement += whosgoing[i].username;
                    whosnotElement += '</li>';
                }
            }
            whosnotElement += '</ul></div>';

            document.getElementById("whosgoing").innerHTML = whosgoingElement;
            document.getElementById("notattend").innerHTML = whosnotElement;
        });
    }

    function postMessage() {
        var message = document.getElementById("postmessage").value;
        var json = { activityId: ACTIVITY_ID, message: message };
        document.getElementById("postmessage").value = '';

        sendPost("/postmessage", JSON.stringify(json), function(response) {
            loadPosts();
        });          
    }

    function announceMessage() {
        var message = document.getElementById("postmessage").value;
        var json = { activityId: ACTIVITY_ID, country: COUNTRY, region: REGION, city: CITY, game: GAME, message: message };
        document.getElementById("postmessage").value = '';

        sendPost("/announcemessage", JSON.stringify(json), function(response) {
            loadPosts();
        });         
    }

    function attend() {
        var json = { activityId: ACTIVITY_ID };

        var attend = document.getElementById("attend");
        var unattend = document.getElementById("unattend");
        attend.style = "display: none";
        unattend.style = "display: inline";

        sendPost("/attend", JSON.stringify(json), function(response) {
            loadWhosGoing();
        });         
    }

    function unattend() {
        var json = { activityId: ACTIVITY_ID };

        var attend = document.getElementById("attend");
        var unattend = document.getElementById("unattend");
        attend.style = "display: inline";
        unattend.style = "display: none";

        sendPost("/unattend", JSON.stringify(json), function(response) {
            loadWhosGoing();
        });         
    }

    function invite() {
        var toEmail = document.getElementById("toemail").value;
        var json = { activityId: ACTIVITY_ID, country: COUNTRY, region: REGION, city: CITY, game: GAME, toEmail: toEmail };
        document.getElementById("toemail").value = '';

        sendPost("/invite", JSON.stringify(json), function(response) {
            // update nothing
        });         
    }
</script>

<body>
    <div class="jumbotron text-center">
        <div class="container">
            <div class="row">
                <div class="col">
                    <span class="pull-left">
					!%BREADCRUMB%!
				</span>
                </div>
            </div>
        </div>
		<div>
			<br/>
			!%LOGIN%!
		</div>
        <h1 class="display-3">!%TITLE%!</h1>
        <p>!%TIME%!</p>
        <hr class="my-4">
        <p class="lead">!%DESCRIPTION%!</p>

        <div class="btn-toolbar">
            <input type="hidden" name="activityId" value="!%ACTIVITYID%!"></input>
            <input type="hidden" name="action" id="hiddenaction"></input>
            <input type="hidden" name="remove_email" id="remove_email"></input>
            
            <div class="btn-group" style="display: !%SHOWCHANNEL%!">				
                <button type="button" class="btn btn-default dropdown-toggle btn-primary" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Channel <span class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a href="#" onclick="document.getElementById('hiddenaction').value='join'; document.getElementById('actionsForm').submit();" style="display: !%SHOWJOIN%!">Join</a></li>
                    <li><a href="#" onclick="document.getElementById('hiddenaction').value='unjoin'; document.getElementById('actionsForm').submit();" style="display: !%SHOWUNJOIN%!">Leave</a></li>
                    <li><a href="#" onclick="document.getElementById('hiddenaction').value='editmode'; document.getElementById('actionsForm').submit();" style="display: !%SHOWEDIT%!">Edit</a></li>
                    <li><a href="#" onclick="alert('Reset handled by cronjob, thanks Patrick');">Reset</a></li>
                </ul>
            </div>
            
            <button onclick="attend();" id="attend" class="btn btn-primary" style="display: !%SHOWATTEND%!">Yes</button>
            <button onclick="unattend();" id="unattend" class="btn btn-primary" style="display: !%SHOWUNATTEND%!">No</button>				
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group" style="display: !%SHOWINVITE%!">
                    <div class="input-group col-xs-9">
                        <input type="email" name="toemail" id="toemail" class="form-control" placeholder="invite peter@gmail.com">
                        <span class="input-group-btn">
                            <button class="btn btn-primary" onclick="invite();"><span class="glyphicon glyphicon-envelope"></span></button>
                        </span>
                    </div>
                </div>
                <h3>Whos going</h3>
                <p id="whosgoing"></p>
                <p id="notattend"></p>
            </div>
			<br/>
            <div class="col-sm-6">
                <div class="form-group">
                    <div class="input-group">
                        <textarea class="form-control" rows="3" cols="90" maxlength="256" id="postmessage" placeholder="what's happening ?"></textarea>
                    </div>
                    <button class="btn btn-primary pull-left" value="post" onclick="postMessage();"><span class="glyphicon glyphicon-pencil"></span> Post</button>
                    <button class="btn btn-danger pull-right" value="announce"  onclick="announceMessage();">Announce <span class="glyphicon glyphicon-envelope"></span></button>
                </div>
                <br/>
                <p id="posts">
				</p></center>
            </div>
        </div>
    </div>
</body>

<script>
    loadPosts();
    loadWhosGoing();
</script>

</html>
