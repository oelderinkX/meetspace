<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<style>
.jumbotron {
    padding: 15px;
    margin-bottom: 30px;
    border-radius: 0;
}
</style>

<script type="application/javascript">

function setCookie(cname, cvalue, exdays) {
  var d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  var expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function search() {
	var link = '';
	var country = document.getElementById("country");
	var region = document.getElementById("region");
	var city = document.getElementById("city");
	
	//region.options[region.selectedIndex].text
	
	if (country && country.value) {
		link += country.value.split(',')[1];

		if (region && region.value) {
			link += "/" + region.options[region.selectedIndex].text.toLowerCase();

			if (city && city.selectedIndex >= 0) {
				link += "/" + city.options[city.selectedIndex].text.toLowerCase();;
			}
		}
	}
	
	if (link.length > 0) {
		window.location.href = 'http://www.meetspace.co.nz/' + link;
	}
}

function getLocation(param, callback) {
	var url = 'http://www.meetspace.co.nz/location?get=';
    var http = new XMLHttpRequest(); // a new request
    http.open('GET' ,url + param,true);
	
	http.onload = function(e) {
		if (http.readyState === 4 && http.status === 200) {
			callback(JSON.parse(http.responseText));
		}
	};
	
	http.send(null);    
}

function loadRegion(country) {
	var regioncombo = document.getElementById("regioncombo");

	if (!country) {
		var citycombo = document.getElementById("citycombo");
		var searchbutton = document.getElementById("searchbutton");
		citycombo.style.visibility = "hidden";
		searchbutton.style.visibility = "hidden";
		hideRegionCombo();
		return;
	}
	
	regioncombo.innerHTML = "<div class='input-group-prepend'><label class='input-group-text'>Region</label></div><select id='region' onchange='setRegion()'></select>";
	
	clearRegions();
	var select = document.getElementById("region");
	var idAndCode = country.split(',');
	
	getLocation('regions&id=' + idAndCode[0], function(regions) {
		if(regions) {
			var option = document.createElement('option');
			option.text = "";
			option.value = "";
			select.appendChild(option, 0);		
		
			for(var i = 0; i < regions.length; i++) {
				var option = document.createElement('option');
				option.text = regions[i].name;
				option.value = regions[i].id;
				select.appendChild(option, 0);
			}
			
			select.value = getCookie("region")

			var citycombo = document.getElementById("citycombo");
			var searchbutton = document.getElementById("searchbutton");
			var regioncombo = document.getElementById("regioncombo");
			citycombo.style.visibility = "visible";
			searchbutton.style.visibility = "visible";
			regioncombo.style.visibility = "visible";
		}
	});
}

function loadCity(region) {

	if (!country) {
		var citycombo = document.getElementById("citycombo");
		var searchbutton = document.getElementById("searchbutton");
		citycombo.style.visibility = "hidden";
		searchbutton.style.visibility = "hidden";
		return;
	}
	
	clearCities();
	var select = document.getElementById("city");

	getLocation('cities&id=' +region, function(cities) {
		if(cities) {
			var option = document.createElement('option');
			option.text = "";
			option.value = "";
			select.appendChild(option, 0);		
		
			for(var i = 0; i < cities.length; i++) {
				var option = document.createElement('option');
				option.text = cities[i].name;
				option.value = cities[i].name;
				select.appendChild(option, 0);
			}
			
			select.value = "christchurch"; //use cookie here
			
			var citycombo = document.getElementById("citycombo");
			var searchbutton = document.getElementById("searchbutton");
			citycombo.style.visibility = "visible";
			searchbutton.style.visibility = "visible";
		}
	});
}

window.onload = function() {
	getLocation('countries', function(countries) {
		var select = document.getElementById("country");
		
		for(var i = 0; i < countries.length; i++) {
			var option = document.createElement('option');
			option.text = countries[i].name;
			option.value = countries[i].id + ',' + countries[i].code;
			
			select.appendChild(option, 0);
		}
		
		select.value = getCookie("country")
		loadRegion(select.value);
	});
}

function setCountry() {
	var combobox = document.getElementById("country");
	setCookie("country", combobox.value, 30);
	 
	loadRegion(combobox.value);
}

function setRegion() {
	var combobox = document.getElementById("region");
	setCookie("region", combobox.value, 30);

	loadCity(combobox.value);
}

function clearRegions() {
	var select = document.getElementById("region");
	
	while (select.firstChild) {
		select.removeChild(select.firstChild);
	}
}

function clearCities() {
	var select = document.getElementById("city");
	
	while (select.firstChild) {
		select.removeChild(select.firstChild);
	}
}

function hideRegionCombo() {
	var regioncombo = document.getElementById("regioncombo");
	regioncombo.innerHTML = "";
}
</script>

<body>
<div class="jumbotron text-center">
  <h1>Meetspace</h1>
  <p>A place to meet people in the real world</p>
  !%MAINHEADING%!
</div>
<div class="container">
	<div class="row">
		 <div class="col-sm-6">
			<h3>Search for activities in your area</h3>
				<div class="input-group">
					<div class="input-group-prepend">
						<label class="input-group-text">Country</label>
					</div>
					<select id="country" class="custom-select" onchange="setCountry()"></select>
				</div>
				
				<div class="input-group">
					<span id="regioncombo" style="visibility: hidden;">\
						<div class="input-group-prepend">
							<label class="input-group-text">Region</label>
						</div>
					</span>
				</div>
				
				<div class="input-group">
					<span id="citycombo" style="visibility: hidden;">
						<div class="input-group-prepend">
							<label class="input-group-text">City</label>
						</div>
						<select id="city"></select>
					</span>
				</div>
					
				<div>
					<span id="searchbutton" style="visibility: hidden;"><br/>
					<input type=button class="btn btn-default btn-primary" value="Search" onclick="search();"/></span>
				</div>
			</p>
		</div>
	</div>
</div>
</body>
</html>